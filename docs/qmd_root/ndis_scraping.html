<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tina Lasisi | João P. Donadio">
<meta name="dcterms.date" content="2025-10-05">

<title>NDIS Database – PODFRIDGE-Databases</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-985aa47af68dae11cd4d235c71fb941e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-dfb324f25d9b1687192fa8be62ac8f9c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PODFRIDGE-Databases</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-analyses" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Analyses</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-analyses">    
        <li>
    <a class="dropdown-item" href="../qmd_root/ndis_scraping.html">
 <span class="dropdown-text">NDIS scraping methodology</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../qmd_root/ndis_analysis.html">
 <span class="dropdown-text">NDIS analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../qmd_root/sdis_summary.html">
 <span class="dropdown-text">SDIS summary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../qmd_root/foia_processing.html">
 <span class="dropdown-text">FOIA processing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../qmd_root/appendix_analysis.html">
 <span class="dropdown-text">Annual DNA Collection</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">Objectives</a></li>
  </ul></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#setup-configuration" id="toc-setup-configuration" class="nav-link" data-scroll-target="#setup-configuration">Setup and Configuration</a>
  <ul class="collapse">
  <li><a href="#system-requirements" id="toc-system-requirements" class="nav-link" data-scroll-target="#system-requirements">System Requirements</a></li>
  <li><a href="#project-structure" id="toc-project-structure" class="nav-link" data-scroll-target="#project-structure">Project Structure</a></li>
  </ul></li>
  <li><a href="#WMSS" id="toc-WMSS" class="nav-link" data-scroll-target="#WMSS">Wayback Machine Snapshot Search</a>
  <ul class="collapse">
  <li><a href="#scrap-method" id="toc-scrap-method" class="nav-link" data-scroll-target="#scrap-method">Scraping Method</a></li>
  <li><a href="#technical-impl" id="toc-technical-impl" class="nav-link" data-scroll-target="#technical-impl">Technical Implementation</a></li>
  <li><a href="#core-search" id="toc-core-search" class="nav-link" data-scroll-target="#core-search">Core Search Implementation</a></li>
  <li><a href="#execution-search" id="toc-execution-search" class="nav-link" data-scroll-target="#execution-search">Search Execution</a></li>
  </ul></li>
  <li><a href="#downloaderSnap" id="toc-downloaderSnap" class="nav-link" data-scroll-target="#downloaderSnap">Snapshot Downloader</a>
  <ul class="collapse">
  <li><a href="#download-method" id="toc-download-method" class="nav-link" data-scroll-target="#download-method">Download Methods</a></li>
  <li><a href="#download-exec" id="toc-download-exec" class="nav-link" data-scroll-target="#download-exec">Download Execution</a></li>
  <li><a href="#download-validation" id="toc-download-validation" class="nav-link" data-scroll-target="#download-validation">Download Validation</a></li>
  </ul></li>
  <li><a href="#extraction-pipe" id="toc-extraction-pipe" class="nav-link" data-scroll-target="#extraction-pipe">Data Extraction</a>
  <ul class="collapse">
  <li><a href="#extraction-overview" id="toc-extraction-overview" class="nav-link" data-scroll-target="#extraction-overview">Extraction Overview</a></li>
  <li><a href="#parser-functions" id="toc-parser-functions" class="nav-link" data-scroll-target="#parser-functions">Core Parser Functions</a></li>
  <li><a href="#era-parsers" id="toc-era-parsers" class="nav-link" data-scroll-target="#era-parsers">Era-Specific Parsers</a></li>
  <li><a href="#output-schema" id="toc-output-schema" class="nav-link" data-scroll-target="#output-schema">Output Schema</a></li>
  <li><a href="#batch-processing" id="toc-batch-processing" class="nav-link" data-scroll-target="#batch-processing">Batch Processing</a></li>
  <li><a href="#exp-valid" id="toc-exp-valid" class="nav-link" data-scroll-target="#exp-valid">Export &amp; Validation</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">NDIS Database</h1>
<p class="subtitle lead">Collecting and Parsing FBI National DNA Index System Statistics from Wayback Machine</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tina Lasisi | João P. Donadio </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 5, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The National DNA Index System (NDIS) is the central database that allows accredited forensic laboratories across the United States to electronically exchange and compare DNA profiles. Maintained by the FBI as part of CODIS (Combined DNA Index System), NDIS tracks the accumulation of DNA records contributed by federal, state, and local laboratories.</p>
<p>This project focuses on systematically compiling the growth and evolution of NDIS by parsing historical statistics published on the FBI’s website and preserved in the Internet Archive’s Wayback Machine. These snapshots contain tables reporting the number of DNA profiles stored in NDIS (offender, arrestee, forensic), as well as information on laboratory participation across jurisdictions.</p>
<section id="objectives" class="level3">
<h3 class="anchored" data-anchor-id="objectives">Objectives</h3>
<ol type="1">
<li><p>Develop a reproducible pipeline to extract NDIS statistics from archived FBI webpages in the Wayback Machine.</p></li>
<li><p>Identify and correct inconsistencies and data quality issues across historical snapshots.</p></li>
<li><p>Document the expansion of DNA profiles (offender, arrestee, forensic) over time.</p></li>
</ol>
</section>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/ndis/methodology.png" class="img-fluid figure-img"></p>
<figcaption>Project step-by-step</figcaption>
</figure>
</div>
<section id="setup-configuration" class="level2">
<h2 class="anchored" data-anchor-id="setup-configuration">Setup and Configuration</h2>
<section id="system-requirements" class="level3">
<h3 class="anchored" data-anchor-id="system-requirements">System Requirements</h3>
<p><strong>Required Packages:</strong></p>
<ul>
<li><p>Core: requests, beautifulsoup4, and lxml (scraping/parsing).</p></li>
<li><p>Data/Visualization: pandas and tqdm (progress tracking).</p></li>
</ul>
<div id="setup" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show Configuration code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>required_packages <span class="op">=</span> [</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'requests'</span>,         <span class="co"># API/HTTP</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'beautifulsoup4'</span>,   <span class="co"># HTML parsing</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'lxml'</span>,             <span class="co"># Faster parsing</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pandas'</span>,           <span class="co"># Data handling</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tqdm'</span>,              <span class="co"># Progress bars</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'hashlib'</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'collections'</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pathlib'</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'datetime'</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'os'</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> package <span class="kw">in</span> required_packages:</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        importlib.import_module(package)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"✓ </span><span class="sc">{</span>package<span class="sc">}</span><span class="ss"> already installed"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Installing </span><span class="sc">{</span>package<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        subprocess.check_call([sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, package])</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"📚 All required packages are installed."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="project-structure" class="level3">
<h3 class="anchored" data-anchor-id="project-structure">Project Structure</h3>
<p><strong>Main Configurations:</strong></p>
<ul>
<li><p>Directory paths for raw HTML (data_snapshots), metadata (data_metadata), and outputs (data_outputs).</p></li>
<li><p>Standardization mappings for jurisdiction names and known data typos.</p></li>
</ul>
<div id="config" class="cell" data-results="hold" data-execution_count="2">
<details class="code-fold">
<summary>Show Configuration code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re, json, requests, time, hashlib</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>BASE_DIR <span class="op">=</span> Path(<span class="st">".."</span>)  <span class="co"># Project root directory</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>HTML_DIR <span class="op">=</span> BASE_DIR <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"ndis"</span> <span class="op">/</span> <span class="st">"raw"</span> <span class="op">/</span> <span class="st">"ndis_snapshots"</span>    <span class="co"># Storage for downloaded HTML</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>META_DIR <span class="op">=</span> BASE_DIR <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"ndis"</span> <span class="op">/</span> <span class="st">"raw"</span> <span class="op">/</span> <span class="st">"ndis_metadata"</span>    <span class="co"># Metadata storage</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>OUTPUT_DIR <span class="op">=</span> BASE_DIR <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"ndis"</span> <span class="op">/</span> <span class="st">"raw"</span> <span class="op">/</span> <span class="st">"ndis_outputs"</span>       <span class="co"># Processed data output</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>NDIS_SNAPSHOTS_DIR <span class="op">=</span> HTML_DIR</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>NDIS_SNAPSHOTS_DIR.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create directory structure</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> directory <span class="kw">in</span> [HTML_DIR, META_DIR, OUTPUT_DIR]:</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    directory.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1edaf647" class="cell" data-execution_count="3">
<div class="cell-output cell-output-stdout">
<pre><code>Project directories initialized:
  - Working directory: C:\Users\Donadio\Documents\PODFRIDGE_Databases
  - HTML storage: ..\data\ndis\raw\ndis_snapshots
  - Metadata directory: ..\data\ndis\raw\ndis_metadata
  - Output directory: ..\data\ndis\raw\ndis_outputs</code></pre>
</div>
</div>
</section>
</section>
<section id="WMSS" class="level2">
<h2 class="anchored" data-anchor-id="WMSS">Wayback Machine Snapshot Search</h2>
<p>A function was developed to systematically search the Internet Archive’s Wayback Machine for all preserved snapshots of FBI NDIS statistics pages using a comprehensive multi-phase approach.</p>
<section id="scrap-method" class="level3">
<h3 class="anchored" data-anchor-id="scrap-method">Scraping Method</h3>
<ol type="1">
<li><strong>Multi-Phase Search Strategy</strong>:</li>
</ol>
<ul>
<li><p>First searches for snapshots from the pre-2007 era using state-specific URLs</p></li>
<li><p>Then targets consolidated pages from post-2007 periods</p></li>
<li><p>Handles both HTTP and HTTPS protocol variants</p></li>
</ul>
<ol start="2" type="1">
<li><strong>Robust Error Handling</strong>:</li>
</ol>
<ul>
<li><p>Automatic retries with exponential backoff (1s → 2s → 4s delays)</p></li>
<li><p>Deduplicates results by timestamp</p></li>
<li><p>Failed requests are tracked and retried with increased retry attempts</p></li>
<li><p>Preserves complete error context for troubleshooting</p></li>
</ul>
</section>
<section id="technical-impl" class="level3">
<h3 class="anchored" data-anchor-id="technical-impl">Technical Implementation</h3>
<ol type="1">
<li><p>API Request</p></li>
<li><p>Converts JSON responses to clean DataFrame</p></li>
<li><p>Sorts chronologically (oldest → newest)</p></li>
</ol>
</section>
<section id="core-search" class="level3">
<h3 class="anchored" data-anchor-id="core-search">Core Search Implementation</h3>
<ul>
<li><strong>make_request_with_retry()</strong>: Implements exponential backoff (1s → 2s → 4s delays) for fault-tolerant API requests with configurable retry attempts.</li>
</ul>
<div id="snapshot-search1" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show search helpers function code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_request_with_retry(params, max_retries<span class="op">=</span><span class="dv">3</span>, initial_delay<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    API_URL <span class="op">=</span> <span class="st">"https://web.archive.org/cdx/search/cdx"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    delay <span class="op">=</span> initial_delay</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            resp <span class="op">=</span> requests.get(API_URL, params<span class="op">=</span>params, timeout<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            resp.raise_for_status()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✓ Successful request for </span><span class="sc">{</span>params[<span class="st">'url'</span>]<span class="sc">}</span><span class="ss"> (offset: </span><span class="sc">{</span>params<span class="sc">.</span>get(<span class="st">'offset'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> resp</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">==</span> max_retries <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"✗ Final attempt failed for </span><span class="sc">{</span>params[<span class="st">'url'</span>]<span class="sc">}</span><span class="ss"> (offset: </span><span class="sc">{</span>params<span class="sc">.</span>get(<span class="st">'offset'</span>, <span class="dv">0</span>)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"! Attempt </span><span class="sc">{</span>attempt<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> failed for </span><span class="sc">{</span>params[<span class="st">'url'</span>]<span class="sc">}</span><span class="ss">, retrying in </span><span class="sc">{</span>delay<span class="sc">}</span><span class="ss"> seconds..."</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            time.sleep(delay)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            delay <span class="op">*=</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="pre-2007-clickmap-era" class="level4">
<h4 class="anchored" data-anchor-id="pre-2007-clickmap-era">Pre-2007 (Clickmap Era)</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/snapshot_2001.png" class="img-fluid figure-img"></p>
<figcaption>Pre-2007 Table Format</figcaption>
</figure>
</div>
<ul>
<li><p>Each state/agency has its own page (e.g., ne.htm for Nebraska, dc.htm for DC/FBI Lab).</p></li>
<li><p>The search iterates through the known two-letter codes and queries Wayback for each URL individually.</p></li>
<li><p><strong>search_pre2007_snapshots()</strong>: Searches individual state-specific pages using 50+ state codes (al.htm, ak.htm, etc.).</p></li>
</ul>
<div id="snapshot-search2" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show pre-2007 search function code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search_pre2007_snapshots():</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    state_codes <span class="op">=</span> [<span class="st">"al"</span>, <span class="st">"ak"</span>, <span class="st">"az"</span>, <span class="st">"ar"</span>, <span class="st">"ca"</span>, <span class="st">"co"</span>, <span class="st">"ct"</span>, <span class="st">"de"</span>, <span class="st">"dc"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"fl"</span>, <span class="st">"ga"</span>, <span class="st">"hi"</span>, <span class="st">"id"</span>, <span class="st">"il"</span>, <span class="st">"in"</span>, <span class="st">"ia"</span>, <span class="st">"ks"</span>, <span class="st">"ky"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"la"</span>, <span class="st">"me"</span>, <span class="st">"md"</span>, <span class="st">"ma"</span>, <span class="st">"mi"</span>, <span class="st">"mn"</span>, <span class="st">"ms"</span>, <span class="st">"mo"</span>, <span class="st">"mt"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"ne"</span>, <span class="st">"nv"</span>, <span class="st">"nh"</span>, <span class="st">"nj"</span>, <span class="st">"nm"</span>, <span class="st">"ny"</span>, <span class="st">"nc"</span>, <span class="st">"nd"</span>, <span class="st">"oh"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"ok"</span>, <span class="st">"or"</span>, <span class="st">"pa"</span>, <span class="st">"pr"</span>, <span class="st">"ri"</span>, <span class="st">"sc"</span>, <span class="st">"sd"</span>, <span class="st">"tn"</span>, <span class="st">"tx"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"army"</span>, <span class="st">"ut"</span>, <span class="st">"vt"</span>, <span class="st">"va"</span>, <span class="st">"wa"</span>, <span class="st">"wv"</span>, <span class="st">"wi"</span>, <span class="st">"wy"</span>]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    all_rows <span class="op">=</span> []</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    seen_timestamps <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    total_saved <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Starting pre-2007 snapshot search for </span><span class="sc">{</span><span class="bu">len</span>(state_codes)<span class="sc">}</span><span class="ss"> state codes at </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, code <span class="kw">in</span> <span class="bu">enumerate</span>(state_codes, <span class="dv">1</span>):</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> <span class="ss">f"http://www.fbi.gov/hq/lab/codis/</span><span class="sc">{</span>code<span class="sc">}</span><span class="ss">.htm"</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        offset <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        state_snapshots <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        has_more_results <span class="op">=</span> <span class="va">True</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(state_codes)<span class="sc">}</span><span class="ss">] Searching for </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> snapshots..."</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> has_more_results:</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            params <span class="op">=</span> {</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"url"</span>: url,</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"matchType"</span>: <span class="st">"exact"</span>,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"output"</span>: <span class="st">"json"</span>,</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"fl"</span>: <span class="st">"timestamp,original,mimetype,statuscode"</span>,</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"filter"</span>: [<span class="st">"statuscode:200"</span>, <span class="st">"mimetype:text/html"</span>],</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"limit"</span>: <span class="st">"5000"</span>,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"offset"</span>: <span class="bu">str</span>(offset)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            resp <span class="op">=</span> make_request_with_retry(params, max_retries<span class="op">=</span><span class="dv">5</span>, initial_delay<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> resp: </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"✗ Failed to retrieve </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> resp.json()</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  No more results for </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> at offset </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                has_more_results <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            new_snapshots <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> row <span class="kw">in</span> data[<span class="dv">1</span>:]:</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                timestamp <span class="op">=</span> row[<span class="dv">0</span>]</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> timestamp <span class="kw">not</span> <span class="kw">in</span> seen_timestamps:</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>                    all_rows.append(row)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>                    seen_timestamps.add(timestamp)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>                    new_snapshots <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>                    state_snapshots <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>                    total_saved <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_snapshots <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  → Saved </span><span class="sc">{</span>new_snapshots<span class="sc">}</span><span class="ss"> new snapshots for </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> (offset: </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if we've reached the end of results</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&lt;</span> <span class="dv">5001</span>:</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  Reached end of results for </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss"> at offset </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>                has_more_results <span class="op">=</span> <span class="va">False</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>                offset <span class="op">+=</span> <span class="dv">5000</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">1</span>)  <span class="co"># Brief pause between requests</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state_snapshots <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✓ Found </span><span class="sc">{</span>state_snapshots<span class="sc">}</span><span class="ss"> total snapshots for </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✗ No snapshots found for </span><span class="sc">{</span>code<span class="sc">.</span>upper()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Pre-2007 search completed. Total snapshots saved: </span><span class="sc">{</span>total_saved<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(all_rows, columns<span class="op">=</span>[<span class="st">"timestamp"</span>,<span class="st">"original"</span>,<span class="st">"mimetype"</span>,<span class="st">"status"</span>]), <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="post-2007-consolidated-pages" class="level4">
<h4 class="anchored" data-anchor-id="post-2007-consolidated-pages">Post-2007 (Consolidated Pages)</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/ndis/snapshots/snapshot_2008.png" class="img-fluid figure-img"></p>
<figcaption>2008 Table Format</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/ndis/snapshots/snapshot_2025.png" class="img-fluid figure-img"></p>
<figcaption>2025 Table Format</figcaption>
</figure>
</div>
<ul>
<li><p>All state/agency records are on a single page per snapshot.</p></li>
<li><p>Searches use the known consolidated URL patterns per era.</p></li>
<li><p><strong>search_post2007_snapshots()</strong>: Searches consolidated pages across 5 historical URL patterns with both HTTP and HTTPS variants.</p></li>
</ul>
<div id="snapshot-search3" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show search function code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search_post2007_snapshots():</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    urls <span class="op">=</span> [</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.fbi.gov/hq/lab/codis/stats.htm"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.fbi.gov/about-us/lab/codis/ndis-statistics"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.fbi.gov/about-us/lab/biometric-analysis/codis/ndis-statistics"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.fbi.gov/services/laboratory/biometric-analysis/codis/ndis-statistics"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://le.fbi.gov/science-and-lab/biometrics-and-fingerprints/codis/codis-ndis-statistics"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    all_rows <span class="op">=</span> []</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    seen_timestamps <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    protocols <span class="op">=</span> [<span class="st">"http://"</span>, <span class="st">"https://"</span>]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    total_saved <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Starting post-2007 snapshot search for </span><span class="sc">{</span><span class="bu">len</span>(urls)<span class="sc">}</span><span class="ss"> URLs at </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, base_url <span class="kw">in</span> <span class="bu">enumerate</span>(urls, <span class="dv">1</span>):</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        url_snapshots <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> protocol <span class="kw">in</span> protocols:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            current_url <span class="op">=</span> base_url.replace(<span class="st">"https://"</span>,<span class="st">""</span>).replace(<span class="st">"http://"</span>,<span class="st">""</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            full_url <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>protocol<span class="sc">}{</span>current_url<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            has_more_results <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">[</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(urls)<span class="sc">}</span><span class="ss">] Searching for </span><span class="sc">{</span>full_url<span class="sc">}</span><span class="ss"> snapshots..."</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> has_more_results:</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                params <span class="op">=</span> {</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"url"</span>: full_url,</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"matchType"</span>: <span class="st">"exact"</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"output"</span>: <span class="st">"json"</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fl"</span>: <span class="st">"timestamp,original,mimetype,statuscode"</span>,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"filter"</span>: [<span class="st">"statuscode:200"</span>, <span class="st">"mimetype:text/html"</span>],</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"limit"</span>: <span class="st">"5000"</span>,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"offset"</span>: <span class="bu">str</span>(offset)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>                resp <span class="op">=</span> make_request_with_retry(params, max_retries<span class="op">=</span><span class="dv">5</span>, initial_delay<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> resp: </span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"✗ Failed to retrieve </span><span class="sc">{</span>full_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> resp.json()</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"  No more results for </span><span class="sc">{</span>full_url<span class="sc">}</span><span class="ss"> at offset </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>                    has_more_results <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                new_snapshots <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> row <span class="kw">in</span> data[<span class="dv">1</span>:]:</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                    timestamp <span class="op">=</span> row[<span class="dv">0</span>]</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> timestamp <span class="kw">not</span> <span class="kw">in</span> seen_timestamps:</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>                        all_rows.append(row)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>                        seen_timestamps.add(timestamp)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>                        new_snapshots <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                        url_snapshots <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                        total_saved <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> new_snapshots <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"  → Saved </span><span class="sc">{</span>new_snapshots<span class="sc">}</span><span class="ss"> new snapshots for </span><span class="sc">{</span>full_url<span class="sc">}</span><span class="ss"> (offset: </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&lt;</span> <span class="dv">5001</span>:</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"  Reached end of results for </span><span class="sc">{</span>full_url<span class="sc">}</span><span class="ss"> at offset </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>                    has_more_results <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>                    offset <span class="op">+=</span> <span class="dv">5000</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                    time.sleep(<span class="dv">1</span>)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> url_snapshots <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✓ Found </span><span class="sc">{</span>url_snapshots<span class="sc">}</span><span class="ss"> total snapshots for </span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✗ No snapshots found for </span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Post-2007 search completed. Total snapshots saved: </span><span class="sc">{</span>total_saved<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(all_rows, columns<span class="op">=</span>[<span class="st">"timestamp"</span>,<span class="st">"original"</span>,<span class="st">"mimetype"</span>,<span class="st">"status"</span>]), <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="execution-search" class="level3">
<h3 class="anchored" data-anchor-id="execution-search">Search Execution</h3>
<ul>
<li><p>Calls both pre-2007 and post-2007 search functions to retrieve comprehensive NDIS records.</p></li>
<li><p>Combines results and removes duplicates based on timestamps.</p></li>
<li><p>Stores technical details (timestamps, URL variants, duplicate counts) in structured JSON metadata.</p></li>
<li><p>Provides detailed logging and progress tracking throughout the search process.</p></li>
</ul>
<div id="execute-search" class="cell" data-message="false" data-execution_count="7">
<details class="code-fold">
<summary>Show search code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pre2007_df, _ <span class="op">=</span> search_pre2007_snapshots()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>post2007_df, _ <span class="op">=</span> search_post2007_snapshots()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all snapshots</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>snap_df <span class="op">=</span> pd.concat([pre2007_df, post2007_df]).drop_duplicates(<span class="st">"timestamp"</span>).sort_values(<span class="st">"timestamp"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save search metadata</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>search_meta <span class="op">=</span> {</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"search_performed"</span>: datetime.now().isoformat(),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_snapshots"</span>: <span class="bu">len</span>(snap_df),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"time_span"</span>: {</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"first"</span>: snap_df[<span class="st">"timestamp"</span>].<span class="bu">min</span>(),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"last"</span>: snap_df[<span class="st">"timestamp"</span>].<span class="bu">max</span>()</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"url_variants"</span>: snap_df[<span class="st">"original"</span>].nunique()</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(META_DIR <span class="op">/</span> <span class="st">"search_metadata.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    json.dump(search_meta, f, indent<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="eb021f69" class="cell" data-execution_count="8">
<div class="cell-output cell-output-stdout">
<pre><code>
Search Results Summary
=====================
Loaded 10310 unique snapshots
Time coverage:
20010715040342
to
20250815002050
Unique URL patterns found: 255
Output saved to: C:\Users\Donadio\Documents\PODFRIDGE_Databases\data\ndis\raw\ndis_metadata/search_metadata.json
</code></pre>
</div>
</div>
</section>
</section>
<section id="downloaderSnap" class="level2">
<h2 class="anchored" data-anchor-id="downloaderSnap">Snapshot Downloader</h2>
<p>This system provides a robust method for downloading historical webpage snapshots from the Internet Archive’s Wayback Machine, specifically designed for the FBI NDIS statistics pages.</p>
<section id="download-method" class="level3">
<h3 class="anchored" data-anchor-id="download-method">Download Methods</h3>
<p>The download system implements a sequential approach optimized for reliability and respectful API usage:</p>
<ul>
<li><p><strong>Resilient Downloading</strong>: Automatic retries with exponential backoff (2s → 4s → 8s → 16s → 32s delays) and extended 60-second timeouts for reliable network handling</p></li>
<li><p><strong>Smart File Management</strong>: Context-aware naming scheme using timestamp + state/scope identifier (e.g., 20040312_ne.html for pre-2007, 20150621_ndis.html for post-2007)</p></li>
<li><p><strong>Duplicate Prevention</strong>: Automatically skips already downloaded files to prevent redundant operations</p></li>
<li><p><strong>Progress Tracking</strong>: Real-time download status with completion counters and detailed success/failure reporting</p></li>
<li><p><strong>Rate Limiting</strong>: 1.5-second delays between requests to avoid overloading the Wayback Machine servers</p></li>
</ul>
<div id="download-helper-codes" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show downloader helpers code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_with_retry(url, save_path, max_retries<span class="op">=</span><span class="dv">4</span>, initial_delay<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Download an archived snapshot with retries and exponential backoff.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    delay <span class="op">=</span> initial_delay</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(max_retries):</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            resp <span class="op">=</span> requests.get(url, timeout<span class="op">=</span><span class="dv">120</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            resp.raise_for_status()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Validate content is reasonable</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(resp.content) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">b"error"</span> <span class="kw">in</span> resp.content.lower() <span class="kw">or</span> <span class="st">b"not found"</span> <span class="kw">in</span> resp.content.lower():</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> requests.exceptions.RequestException(<span class="ss">f"Possible error page: </span><span class="sc">{</span><span class="bu">len</span>(resp.content)<span class="sc">}</span><span class="ss"> bytes"</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save to disk</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(save_path, <span class="st">"wb"</span>) <span class="im">as</span> f:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                f.write(resp.content)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"✓ Downloaded: </span><span class="sc">{</span>save_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> requests.exceptions.RequestException <span class="im">as</span> e:</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">==</span> max_retries <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"✗ Final attempt failed for </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"! Attempt </span><span class="sc">{</span>attempt<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss"> failed, retrying in </span><span class="sc">{</span>delay<span class="sc">}</span><span class="ss">s..."</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            time.sleep(delay)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>            delay <span class="op">*=</span> <span class="dv">2</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> snapshot_to_filepath(row):</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Map a snapshot record to a local filename.</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Format: {timestamp}_{state_or_scope}.html</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> row[<span class="st">"timestamp"</span>]</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    original <span class="op">=</span> row[<span class="st">"original"</span>]</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># derive name from FBI URL pattern</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"/codis/"</span> <span class="kw">in</span> original <span class="kw">and</span> original.endswith(<span class="st">".htm"</span>):</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-2007: use last part (state code or army/dc)</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        suffix <span class="op">=</span> Path(original).stem</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Post-2007: consolidated page, use 'ndis'</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        suffix <span class="op">=</span> <span class="st">"ndis"</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    save_dir <span class="op">=</span> HTML_DIR</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    save_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)  <span class="co"># Ensure directory exists</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> save_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>ts<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>suffix<span class="sc">}</span><span class="ss">.html"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-exec" class="level3">
<h3 class="anchored" data-anchor-id="download-exec">Download Execution</h3>
<p>The download execution phase performs bulk retrieval of historical NDIS snapshots with comprehensive error handling:</p>
<ul>
<li><p><strong>Sequential Processing</strong>: Iterates through snapshot DataFrame chronologically, processing each file individually for maximum reliability</p></li>
<li><p><strong>URL Construction</strong>: Uses identity flag (id_) in archive URLs to retrieve unmodified original content: https://web.archive.org/web/{timestamp}id_/{original}</p></li>
<li><p><strong>Binary Preservation</strong>: Saves files as binary content to maintain original encoding and prevent character corruption</p></li>
<li><p><strong>Comprehensive Logging</strong>: Provides real-time progress updates with attempt counters and final success/failure statistics</p></li>
<li><p><strong>Flexible Limiting</strong>: Optional download limits for testing or partial processing</p></li>
</ul>
<div id="execute-download" class="cell" data-message="false" data-execution_count="10">
<details class="code-fold">
<summary>Show download execution code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_snapshots(snap_df, limit<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Iterate over snapshot DataFrame and download archived HTML pages.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="bu">len</span>(snap_df) <span class="cf">if</span> limit <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> <span class="bu">min</span>(limit, <span class="bu">len</span>(snap_df))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Starting download of </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss"> snapshots at </span><span class="sc">{</span>datetime<span class="sc">.</span>now()<span class="sc">.</span>strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st"> %H:%M:%S'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    successes, failures <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    failed_downloads <span class="op">=</span> []</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">enumerate</span>(snap_df.head(total).itertuples(index<span class="op">=</span><span class="va">False</span>), <span class="dv">1</span>):</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        ts, original, _, _ <span class="op">=</span> row</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        save_path <span class="op">=</span> snapshot_to_filepath(row._asdict())</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> save_path.exists() <span class="kw">and</span> save_path.stat().st_size <span class="op">&gt;</span> <span class="dv">1000</span>:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"- [</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">] Already exists: </span><span class="sc">{</span>save_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        archive_url <span class="op">=</span> <span class="ss">f"https://web.archive.org/web/</span><span class="sc">{</span>ts<span class="sc">}</span><span class="ss">id_/</span><span class="sc">{</span>original<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"- [</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">] Downloading </span><span class="sc">{</span>archive_url<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> download_with_retry(archive_url, save_path):</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            failed_downloads.append({</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">'timestamp'</span>: ts,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">'url'</span>: original,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">'archive_url'</span>: archive_url</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">%</span> <span class="dv">50</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Progress: </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>i<span class="op">/</span>total<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%) - </span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> success, </span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> failures"</span>)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">1.5</span>)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save failure report</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> failed_downloads:</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        failure_report <span class="op">=</span> {</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'download_completed'</span>: datetime.now().isoformat(),</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_attempted'</span>: total,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">'successful'</span>: successes,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">'failed'</span>: failures,</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">'failed_downloads'</span>: failed_downloads</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(META_DIR <span class="op">/</span> <span class="st">"download_failures.json"</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>            json.dump(failure_report, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Download completed. Success: </span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss">, Failures: </span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> successes, failures</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>successes, failures <span class="op">=</span> download_snapshots(snap_df, limit<span class="op">=</span><span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-validation" class="level3">
<h3 class="anchored" data-anchor-id="download-validation">Download Validation</h3>
<p>Post-download validation ensures data integrity and identifies potential issues:</p>
<ul>
<li><p><strong>File Existence Verification</strong>: Checks that all expected files were successfully downloaded to the target directory</p></li>
<li><p><strong>Content Quality Assessment</strong>: Validates HTML content by examining file headers for proper HTML tags</p></li>
<li><p><strong>Error Categorization</strong>: Separates missing files from corrupted/non-HTML files for targeted remediation</p></li>
<li><p><strong>Metadata Generation</strong>: Creates JSON validation reports with detailed statistics and file counts</p></li>
<li><p><strong>Actionable Reporting</strong>: Provides clear feedback on download success rates and files requiring attention</p></li>
</ul>
<div id="verify-downloads" class="cell" data-results="hold" data-execution_count="11">
<details class="code-fold">
<summary>Show download validation code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_downloads(snap_df):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Validate downloaded files exist and are HTML-like.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    missing, bad_html <span class="op">=</span> [], []</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> snap_df.itertuples(index<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        save_path <span class="op">=</span> snapshot_to_filepath(row._asdict())</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> save_path.exists():</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            missing.append(save_path)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            file_size <span class="op">=</span> save_path.stat().st_size</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> file_size <span class="op">&lt;</span> <span class="dv">1000</span>:</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                bad_html.append(save_path)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(save_path, <span class="st">"rb"</span>) <span class="im">as</span> f:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                start <span class="op">=</span> f.read(<span class="dv">500</span>).lower()</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">b"&lt;html"</span> <span class="kw">not</span> <span class="kw">in</span> start <span class="kw">and</span> <span class="st">b"&lt;!doctype"</span> <span class="kw">not</span> <span class="kw">in</span> start:</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                bad_html.append(save_path)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            bad_html.append(save_path)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Validation results → Missing: </span><span class="sc">{</span><span class="bu">len</span>(missing)<span class="sc">}</span><span class="ss">, Bad HTML: </span><span class="sc">{</span><span class="bu">len</span>(bad_html)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> missing, bad_html</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Run validation</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>missing, bad_html <span class="op">=</span> validate_downloads(snap_df)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Save validation summary</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>validation_meta <span class="op">=</span> {</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"validation_performed"</span>: datetime.now().isoformat(),</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"missing_files"</span>: <span class="bu">len</span>(missing),</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bad_html_files"</span>: <span class="bu">len</span>(bad_html),</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_snapshots"</span>: <span class="bu">len</span>(snap_df),</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"successful_downloads"</span>: successes,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"success_rate"</span>: <span class="ss">f"</span><span class="sc">{</span>(successes<span class="op">/</span><span class="bu">len</span>(snap_df))<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%"</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(META_DIR <span class="op">/</span> <span class="st">"validation_metadata.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    json.dump(validation_meta, f, indent<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="fdf6cb7a" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show validation report code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save and print report</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>report_path <span class="op">=</span> META_DIR <span class="op">/</span> <span class="ss">f"validation_metadata.json"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(report_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    json.dump(validation_meta, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DOWNLOAD VALIDATION REPORT"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">60</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Missing files: </span><span class="sc">{</span>validation_meta[<span class="st">'missing_files'</span>]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>validation_meta[<span class="st">'total_snapshots'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Bad HTML files: </span><span class="sc">{</span>validation_meta[<span class="st">'bad_html_files'</span>]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>validation_meta[<span class="st">'total_snapshots'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Successful downloads: </span><span class="sc">{</span>validation_meta[<span class="st">'successful_downloads'</span>]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>validation_meta[<span class="st">'total_snapshots'</span>]<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>validation_meta[<span class="st">'success_rate'</span>]<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Full report: </span><span class="sc">{</span>report_path<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
============================================================
DOWNLOAD VALIDATION REPORT
============================================================
  Missing files: 48/10310
  Bad HTML files: 4/10310
  Successful downloads: 10262/10310 (99.5%)

Full report: ..\data\ndis\raw\ndis_metadata\validation_metadata.json</code></pre>
</div>
</div>
</section>
</section>
<section id="extraction-pipe" class="level2">
<h2 class="anchored" data-anchor-id="extraction-pipe">Data Extraction</h2>
<p>The data extraction pipeline converts downloaded HTML snapshots into structured tabular data, handling the evolution of FBI NDIS reporting formats across different time periods.</p>
<section id="extraction-overview" class="level3">
<h3 class="anchored" data-anchor-id="extraction-overview">Extraction Overview</h3>
<p>The extraction system processes three distinct eras of NDIS reporting:</p>
<ol type="1">
<li><p>Pre-2007 Era: Basic statistics without date metadata or arrestee data</p></li>
<li><p>2007-2011 Era: Includes “as of” dates but no arrestee profiles</p></li>
<li><p>Post-2012 Era: Complete format with all profile types and consistent dating</p></li>
</ol>
<p><strong>Key Features:</strong></p>
<ul>
<li><p><strong>Era-Aware Processing:</strong> Automatically routes files to appropriate parsers based on timestamp</p></li>
<li><p><strong>Metadata Recovery:</strong> Extracts report dates from “as of” statements when available</p></li>
<li><p><strong>Complete Traceability:</strong> Links each record to its source HTML file and original URL</p></li>
<li><p><strong>Robust Error Handling:</strong> Processes files individually to prevent single failures from stopping the entire batch</p></li>
</ul>
</section>
<section id="parser-functions" class="level3">
<h3 class="anchored" data-anchor-id="parser-functions">Core Parser Functions</h3>
<p>Essential text processing utilities for NDIS data extraction:</p>
<ul>
<li><p><strong>HTML Cleaning</strong>: Removes navigation, scripts, and styling elements to focus on data content</p></li>
<li><p><strong>Date Extraction</strong>: Identifies and parses “as of” dates using multiple pattern variations</p></li>
<li><p><strong>Text Normalization</strong>: Standardizes whitespace and jurisdiction name formatting</p></li>
<li><p><strong>Encoding Handling</strong>: Manages various character encodings found in historical snapshots</p></li>
</ul>
<div id="helper-functions" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show setup and normalization functions code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_ndis_metadata(html_content):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract key metadata from NDIS HTML content including report dates</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    dict:</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - report_month: Month from "as of" statement (None if not found)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">        - report_year: Year from "as of" statement (None if not found)  </span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">        - clean_text: Normalized text content</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiple patterns to catch different "as of" formats</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    date_patterns <span class="op">=</span> [</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="pp">[Aa]</span><span class="vs">s of </span><span class="kw">(</span><span class="pp">[A-Za-z]</span><span class="op">+</span><span class="kw">)</span><span class="vs"> </span><span class="kw">(</span><span class="dv">\d</span><span class="op">{4}</span><span class="kw">)</span><span class="vs">'</span>,           <span class="co"># "as of November 2008"</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="pp">[Aa]</span><span class="vs">s of </span><span class="kw">(</span><span class="pp">[A-Za-z]</span><span class="op">+</span><span class="kw">)</span><span class="vs"> </span><span class="kw">(</span><span class="dv">\d</span><span class="op">{1,2}</span><span class="kw">)</span><span class="vs">, </span><span class="kw">(</span><span class="dv">\d</span><span class="op">{4}</span><span class="kw">)</span><span class="vs">'</span>, <span class="co"># "as of November 15, 2008"</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'Statistics as of </span><span class="kw">(</span><span class="pp">[A-Za-z]</span><span class="op">+</span><span class="kw">)</span><span class="vs"> </span><span class="kw">(</span><span class="dv">\d</span><span class="op">{4}</span><span class="kw">)</span><span class="vs">'</span>,    <span class="co"># "Statistics as of November 2008"</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'Statistics as of </span><span class="kw">(</span><span class="pp">[A-Za-z]</span><span class="op">+</span><span class="kw">)</span><span class="vs"> </span><span class="kw">(</span><span class="dv">\d</span><span class="op">{1,2}</span><span class="kw">)</span><span class="vs">, </span><span class="kw">(</span><span class="dv">\d</span><span class="op">{4}</span><span class="kw">)</span><span class="vs">'</span> <span class="co"># "Statistics as of November 15, 2008"</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    report_month <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    report_year <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find first occurrence of any date pattern</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pattern <span class="kw">in</span> date_patterns:</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        date_match <span class="op">=</span> re.search(pattern, html_content)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> date_match:</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>            month_str <span class="op">=</span> date_match.group(<span class="dv">1</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(date_match.groups()) <span class="op">==</span> <span class="dv">2</span>:  <span class="co"># Month + Year only</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                year_str <span class="op">=</span> date_match.group(<span class="dv">2</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># Month + Day + Year</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                year_str <span class="op">=</span> date_match.group(<span class="dv">3</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert month name to number</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>                month_num <span class="op">=</span> pd.to_datetime(<span class="ss">f"</span><span class="sc">{</span>month_str<span class="sc">}</span><span class="ss"> 1, 2000"</span>).month</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                report_month <span class="op">=</span> month_num</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                report_year <span class="op">=</span> <span class="bu">int</span>(year_str)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean HTML and normalize text</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    soup <span class="op">=</span> BeautifulSoup(html_content, <span class="st">'lxml'</span>)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove scripts, styles, and navigation elements</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> element <span class="kw">in</span> soup([<span class="st">'script'</span>, <span class="st">'style'</span>, <span class="st">'nav'</span>, <span class="st">'header'</span>, <span class="st">'footer'</span>]):</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>        element.decompose()</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get clean text with normalized whitespace</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    clean_text <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">\s</span><span class="op">+</span><span class="vs">'</span>, <span class="st">' '</span>, soup.get_text(<span class="st">' '</span>, strip<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">'report_month'</span>: report_month,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'report_year'</span>: report_year, </span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'clean_text'</span>: clean_text</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_jurisdiction_name(name):</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="co">    Clean and standardize jurisdiction names for consistency</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> name:</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> name</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove common prefixes and suffixes</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^.</span><span class="op">*?</span><span class="kw">(</span><span class="vs">Back to top</span><span class="cf">|</span><span class="vs">Tables by NDIS Participant</span><span class="cf">|</span><span class="vs">ation</span><span class="ch">\.</span><span class="kw">)</span><span class="dv">\s</span><span class="op">*</span><span class="vs">'</span>, </span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>                 <span class="st">''</span>, name, flags<span class="op">=</span>re.I).strip()</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize known variants</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    replacements <span class="op">=</span> {</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">'D.C./FBI Lab'</span>: <span class="st">'DC/FBI Lab'</span>,</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">'D.C./Metro PD'</span>: <span class="st">'DC/Metro PD'</span>, </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">'US Army'</span>: <span class="st">'U.S. Army'</span>,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">'D.C.'</span>: <span class="st">'DC'</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> old, new <span class="kw">in</span> replacements.items():</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> name.replace(old, new)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> name.strip()</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_original_url_from_filename(html_file):</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a><span class="co">    Reconstruct original URL from filename and timestamp</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> html_file.name</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    timestamp <span class="op">=</span> filename.split(<span class="st">'_'</span>)[<span class="dv">0</span>]  <span class="co"># Get timestamp part</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine URL pattern based on filename suffix</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filename.endswith(<span class="st">'_ndis.html'</span>):</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Post-2007 consolidated format - use most common URL pattern</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"https://www.fbi.gov/services/laboratory/biometric-analysis/codis/ndis-statistics"</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-2007 state-specific format</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>        state_code <span class="op">=</span> filename.split(<span class="st">'_'</span>)[<span class="dv">1</span>].replace(<span class="st">'.html'</span>, <span class="st">''</span>)</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f"http://www.fbi.gov/hq/lab/codis/</span><span class="sc">{</span>state_code<span class="sc">}</span><span class="ss">.htm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="era-parsers" class="level3">
<h3 class="anchored" data-anchor-id="era-parsers">Era-Specific Parsers</h3>
<p>Time-period-adapted parsing logic that accounts for format evolution:</p>
<p><strong>Pre-2007 Parser:</strong></p>
<ul>
<li><p>Extracts basic statistics from state-specific pages</p></li>
<li><p>Uses timestamp-derived year (no report dates available)</p></li>
<li><p>Sets arrestee counts to 0 (not reported in this era)</p></li>
<li><p>Handles missing NDIS labs and investigations data</p></li>
</ul>
<p><strong>2008-2011 Parser:</strong></p>
<ul>
<li><p>Processes consolidated pages with “Back to top” section dividers</p></li>
<li><p>Extracts month and year from report dates</p></li>
<li><p>Handles missing arrestee data (sets to 0)</p></li>
<li><p>Multiple pattern matching for jurisdiction identification</p></li>
</ul>
<p><strong>2012-2016 Parser:</strong></p>
<ul>
<li><p>First era with arrestee data extraction</p></li>
<li><p>Processes consolidated pages with “Back to top” section dividers</p></li>
<li><p>Multiple pattern matching for jurisdiction identification</p></li>
<li><p>Complete jurisdiction coverage with standardized names</p></li>
</ul>
<p><strong>Post-2017 Parser:</strong></p>
<ul>
<li><p>Modern format with consistent structure and all fields</p></li>
<li><p>Robust regex pattern for reliable extraction</p></li>
<li><p>Full feature extraction including arrestee profiles</p></li>
<li><p>Complete jurisdiction coverage with standardized names</p></li>
</ul>
<div id="parser-functions" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show parser functions code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_pre2007_ndis(text, timestamp, html_file, report_month<span class="op">=</span><span class="va">None</span>, report_year<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse NDIS snapshots from 2001-2007 era (state-specific pages)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    HTML has table structure with state name followed by data rows</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up the text for better matching</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">\s</span><span class="op">+</span><span class="vs">'</span>, <span class="st">' '</span>, text)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try multiple patterns to extract state name</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    jurisdiction <span class="op">=</span> <span class="va">None</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pattern 1: State name in large font (from graphic alt text or heading)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Looking for patterns like "Graphic of Pennsylvania Pennsylvania" or just the state name</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    state_pattern1 <span class="op">=</span> <span class="vs">r'</span>(?:<span class="vs">Graphic of</span><span class="cf">|</span><span class="vs">alt="</span>)<span class="kw">(</span><span class="pp">[A-Z][a-z]</span><span class="op">+</span>(?:<span class="dv">\s</span><span class="op">+</span><span class="pp">[A-Z][a-z]</span><span class="op">+</span>)<span class="op">*?</span><span class="kw">)</span>(?:<span class="vs">"</span><span class="cf">|</span><span class="vs">&gt;</span><span class="cf">|</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Offender</span>)<span class="vs">'</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    state_match <span class="op">=</span> re.search(state_pattern1, text, re.IGNORECASE)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> state_match:</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        jurisdiction <span class="op">=</span> state_match.group(<span class="dv">1</span>).strip()</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pattern 2: Try to extract from filename as fallback</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> jurisdiction:</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract state code from filename (e.g., "20010715040342_pa.html")</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> html_file.name</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        state_code_match <span class="op">=</span> re.search(<span class="vs">r'_</span><span class="kw">(</span><span class="pp">[a-z]</span><span class="op">{2,5}</span><span class="kw">)</span><span class="ch">\.</span><span class="vs">html</span><span class="dv">$</span><span class="vs">'</span>, filename)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state_code_match:</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>            state_code <span class="op">=</span> state_code_match.group(<span class="dv">1</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Map common state codes to names</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            state_map <span class="op">=</span> {</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">'pa'</span>: <span class="st">'Pennsylvania'</span>, <span class="st">'nc'</span>: <span class="st">'North Carolina'</span>, <span class="st">'ct'</span>: <span class="st">'Connecticut'</span>,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'wv'</span>: <span class="st">'West Virginia'</span>, <span class="st">'ks'</span>: <span class="st">'Kansas'</span>, <span class="st">'nd'</span>: <span class="st">'North Dakota'</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">'wy'</span>: <span class="st">'Wyoming'</span>, <span class="st">'ky'</span>: <span class="st">'Kentucky'</span>, <span class="st">'la'</span>: <span class="st">'Louisiana'</span>,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'dc'</span>: <span class="st">'DC/FBI Lab'</span>, <span class="st">'de'</span>: <span class="st">'Delaware'</span>, <span class="st">'ne'</span>: <span class="st">'Nebraska'</span>,</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sc'</span>: <span class="st">'South Carolina'</span>, <span class="st">'tn'</span>: <span class="st">'Tennessee'</span>, <span class="st">'ma'</span>: <span class="st">'Massachusetts'</span>,</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'fl'</span>: <span class="st">'Florida'</span>, <span class="st">'nh'</span>: <span class="st">'New Hampshire'</span>, <span class="st">'sd'</span>: <span class="st">'South Dakota'</span>,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'me'</span>: <span class="st">'Maine'</span>, <span class="st">'hi'</span>: <span class="st">'Hawaii'</span>, <span class="st">'nm'</span>: <span class="st">'New Mexico'</span>,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">'al'</span>: <span class="st">'Alabama'</span>, <span class="st">'tx'</span>: <span class="st">'Texas'</span>, <span class="st">'mi'</span>: <span class="st">'Michigan'</span>,</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ut'</span>: <span class="st">'Utah'</span>, <span class="st">'ar'</span>: <span class="st">'Arkansas'</span>, <span class="st">'az'</span>: <span class="st">'Arizona'</span>,</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">'mo'</span>: <span class="st">'Missouri'</span>, <span class="st">'ny'</span>: <span class="st">'New York'</span>, <span class="st">'mn'</span>: <span class="st">'Minnesota'</span>,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">'vt'</span>: <span class="st">'Vermont'</span>, <span class="st">'id'</span>: <span class="st">'Idaho'</span>, <span class="st">'oh'</span>: <span class="st">'Ohio'</span>,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ok'</span>: <span class="st">'Oklahoma'</span>, <span class="st">'or'</span>: <span class="st">'Oregon'</span>, <span class="st">'ca'</span>: <span class="st">'California'</span>,</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">'il'</span>: <span class="st">'Illinois'</span>, <span class="st">'wi'</span>: <span class="st">'Wisconsin'</span>, <span class="st">'ms'</span>: <span class="st">'Mississippi'</span>,</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">'wa'</span>: <span class="st">'Washington'</span>, <span class="st">'mt'</span>: <span class="st">'Montana'</span>, <span class="st">'in'</span>: <span class="st">'Indiana'</span>,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>                <span class="st">'co'</span>: <span class="st">'Colorado'</span>, <span class="st">'va'</span>: <span class="st">'Virginia'</span>, <span class="st">'ga'</span>: <span class="st">'Georgia'</span>,</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ak'</span>: <span class="st">'Alaska'</span>, <span class="st">'md'</span>: <span class="st">'Maryland'</span>, <span class="st">'nj'</span>: <span class="st">'New Jersey'</span>,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">'nv'</span>: <span class="st">'Nevada'</span>, <span class="st">'ri'</span>: <span class="st">'Rhode Island'</span>, <span class="st">'ia'</span>: <span class="st">'Iowa'</span>,</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">'army'</span>: <span class="st">'U.S. Army'</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            jurisdiction <span class="op">=</span> state_map.get(state_code, state_code.upper())</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> jurisdiction:</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>        jurisdiction <span class="op">=</span> standardize_jurisdiction_name(jurisdiction)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract individual values with more flexible patterns</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># These patterns work with the table structure in your example</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        offender_match <span class="op">=</span> re.search(<span class="vs">r'Offender</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Profiles</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, text, re.IGNORECASE)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>        forensic_match <span class="op">=</span> re.search(<span class="vs">r'Forensic</span><span class="dv">\s</span><span class="op">+</span>(?:<span class="vs">Samples</span><span class="op">?</span><span class="cf">|</span><span class="vs">Profiles</span><span class="op">?</span>)<span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, text, re.IGNORECASE)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># NDIS labs can appear as "NDIS Participating Labs" or just "Number of CODIS Labs"</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>        ndis_labs_match <span class="op">=</span> re.search(<span class="vs">r'</span>(?:<span class="vs">NDIS</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Participating</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Labs</span><span class="op">?</span><span class="cf">|</span><span class="vs">Number</span><span class="dv">\s</span><span class="op">+</span><span class="vs">of</span><span class="dv">\s</span><span class="op">+</span><span class="vs">CODIS</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Labs</span><span class="op">?</span>)<span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, text, re.IGNORECASE)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>        investigations_match <span class="op">=</span> re.search(<span class="vs">r'Investigations</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Aided</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, text, re.IGNORECASE)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> offender_match <span class="kw">and</span> forensic_match:</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>            records.append({</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>                <span class="st">'timestamp'</span>: timestamp,</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>                <span class="st">'report_month'</span>: <span class="va">None</span>,  <span class="co"># Not available pre-2007</span></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>                <span class="st">'report_year'</span>: <span class="va">None</span>,   <span class="co"># Not available pre-2007</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>                <span class="st">'jurisdiction'</span>: jurisdiction,</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>                <span class="st">'offender_profiles'</span>: <span class="bu">int</span>(offender_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>                <span class="st">'arrestee'</span>: <span class="dv">0</span>,  <span class="co"># Not reported pre-2007</span></span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>                <span class="st">'forensic_profiles'</span>: <span class="bu">int</span>(forensic_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ndis_labs'</span>: <span class="bu">int</span>(ndis_labs_match.group(<span class="dv">1</span>)) <span class="cf">if</span> ndis_labs_match <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>                <span class="st">'investigations_aided'</span>: <span class="bu">int</span>(investigations_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)) <span class="cf">if</span> investigations_match <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> records</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_2008_2011_ndis(text, timestamp, html_file, report_month<span class="op">=</span><span class="va">None</span>, report_year<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse NDIS snapshots from 2008-2011 era</span></span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a><span class="co">    Consolidated page with state anchors and "Back to top" links</span></span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a><span class="co">    No arrestee data in this period</span></span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up the text</span></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">\s</span><span class="op">+</span><span class="vs">'</span>, <span class="st">' '</span>, text)</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split by "Back to top" to isolate each state section</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>    sections <span class="op">=</span> re.split(<span class="vs">r'Back</span><span class="dv">\s</span><span class="op">+</span><span class="vs">to</span><span class="dv">\s</span><span class="op">+</span><span class="vs">top'</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> section <span class="kw">in</span> sections:</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Look for state name pattern (appears as anchor or bold text)</span></span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Try multiple patterns to catch different HTML formats</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>        jurisdiction <span class="op">=</span> <span class="va">None</span></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 1: &lt;a name="State"&gt;&lt;/a&gt;&lt;strong&gt;State&lt;/strong&gt;</span></span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>        state_match <span class="op">=</span> re.search(<span class="vs">r'&lt;a</span><span class="dv">\s</span><span class="op">+</span><span class="vs">name="</span><span class="kw">(</span><span class="pp">[^"]</span><span class="op">+</span><span class="kw">)</span><span class="vs">"</span><span class="pp">[^&gt;]</span><span class="op">*</span><span class="vs">&gt;</span><span class="dv">.</span><span class="op">*?</span>(?:<span class="vs">&lt;strong&gt;</span><span class="cf">|</span><span class="vs">&lt;b&gt;</span>)<span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="pp">[A-Z][^&lt;]</span><span class="op">+?</span><span class="kw">)</span>(?:<span class="vs">&lt;/strong&gt;</span><span class="cf">|</span><span class="vs">&lt;/b&gt;</span>)<span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state_match:</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>            jurisdiction <span class="op">=</span> state_match.group(<span class="dv">2</span>).strip()</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 2: Just the state name in bold/strong tags before "Statistical Information"</span></span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> jurisdiction:</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>            state_match <span class="op">=</span> re.search(<span class="vs">r'</span>(?:<span class="vs">&lt;strong&gt;</span><span class="cf">|</span><span class="vs">&lt;b&gt;</span>)<span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="pp">[A-Z][^&lt;]</span><span class="op">+?</span><span class="kw">)</span>(?:<span class="vs">&lt;/strong&gt;</span><span class="cf">|</span><span class="vs">&lt;/b&gt;</span>)<span class="dv">.</span><span class="op">*?</span><span class="vs">Statistical</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Information'</span>, section, re.IGNORECASE)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> state_match:</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a>                jurisdiction <span class="op">=</span> state_match.group(<span class="dv">1</span>).strip()</span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 3: State name without tags before "Statistical Information"</span></span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> jurisdiction:</span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a>            state_match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="kw">(</span><span class="pp">[A-Z][a-z]</span><span class="op">+</span>(?:<span class="dv">\s</span><span class="op">+</span><span class="pp">[A-Z][a-z]</span><span class="op">+</span>)<span class="op">*</span><span class="kw">)</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Statistical</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Information'</span>, section)</span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> state_match:</span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a>                jurisdiction <span class="op">=</span> state_match.group(<span class="dv">1</span>).strip()</span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> jurisdiction:</span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a>            jurisdiction <span class="op">=</span> standardize_jurisdiction_name(jurisdiction)</span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract values</span></span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>            offender_match <span class="op">=</span> re.search(<span class="vs">r'Offender</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Profiles</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>            forensic_match <span class="op">=</span> re.search(<span class="vs">r'Forensic</span><span class="dv">\s</span><span class="op">+</span>(?:<span class="vs">Samples</span><span class="op">?</span><span class="cf">|</span><span class="vs">Profiles</span><span class="op">?</span>)<span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>            ndis_labs_match <span class="op">=</span> re.search(<span class="vs">r'NDIS</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Participating</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Labs</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>            investigations_match <span class="op">=</span> re.search(<span class="vs">r'Investigations</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Aided</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> offender_match <span class="kw">and</span> forensic_match:</span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>                records.append({</span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'timestamp'</span>: timestamp,</span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'report_month'</span>: report_month,</span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'report_year'</span>: report_year,</span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'jurisdiction'</span>: jurisdiction,</span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'offender_profiles'</span>: <span class="bu">int</span>(offender_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'arrestee'</span>: <span class="dv">0</span>,  <span class="co"># Not reported 2008-2011</span></span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'forensic_profiles'</span>: <span class="bu">int</span>(forensic_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'ndis_labs'</span>: <span class="bu">int</span>(ndis_labs_match.group(<span class="dv">1</span>)) <span class="cf">if</span> ndis_labs_match <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'investigations_aided'</span>: <span class="bu">int</span>(investigations_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)) <span class="cf">if</span> investigations_match <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> records</span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_2012_2016_ndis(text, timestamp, html_file, report_month<span class="op">=</span><span class="va">None</span>, report_year<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse NDIS snapshots from 2012-2016 era</span></span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a><span class="co">    Includes arrestee data for the first time</span></span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up the text</span></span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">\s</span><span class="op">+</span><span class="vs">'</span>, <span class="st">' '</span>, text)</span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split by "Back to top" to isolate each state section</span></span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a>    sections <span class="op">=</span> re.split(<span class="vs">r'Back</span><span class="dv">\s</span><span class="op">+</span><span class="vs">to</span><span class="dv">\s</span><span class="op">+</span><span class="vs">top'</span>, text, flags<span class="op">=</span>re.IGNORECASE)</span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> section <span class="kw">in</span> sections:</span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a>        jurisdiction <span class="op">=</span> <span class="va">None</span></span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Look for state name patterns</span></span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 1: &lt;a name="State"&gt;&lt;/a&gt;&lt;b&gt;State&lt;/b&gt;</span></span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a>        state_match <span class="op">=</span> re.search(<span class="vs">r'&lt;a</span><span class="dv">\s</span><span class="op">+</span><span class="vs">name="</span><span class="kw">(</span><span class="pp">[^"]</span><span class="op">+</span><span class="kw">)</span><span class="vs">"</span><span class="pp">[^&gt;]</span><span class="op">*</span><span class="vs">&gt;</span><span class="dv">.</span><span class="op">*?</span><span class="vs">&lt;b&gt;</span><span class="kw">(</span><span class="pp">[^&lt;]</span><span class="op">+?</span><span class="kw">)</span><span class="vs">&lt;/b&gt;'</span>, section, re.IGNORECASE)</span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state_match:</span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a>            jurisdiction <span class="op">=</span> state_match.group(<span class="dv">2</span>).strip()</span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 2: Just bold state name</span></span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> jurisdiction:</span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>            state_match <span class="op">=</span> re.search(<span class="vs">r'&lt;b&gt;</span><span class="kw">(</span><span class="pp">[A-Z][^&lt;]</span><span class="op">+?</span><span class="kw">)</span><span class="vs">&lt;/b&gt;</span><span class="dv">.</span><span class="op">*?</span><span class="vs">Statistical</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Information'</span>, section, re.IGNORECASE)</span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> state_match:</span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a>                jurisdiction <span class="op">=</span> state_match.group(<span class="dv">1</span>).strip()</span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pattern 3: State name without tags</span></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> jurisdiction:</span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a>            state_match <span class="op">=</span> re.search(<span class="vs">r'</span><span class="kw">(</span><span class="pp">[A-Z][a-z]</span><span class="op">+</span>(?:<span class="dv">\s</span><span class="op">+</span><span class="pp">[A-Z][a-z]</span><span class="op">+</span>)<span class="op">*</span><span class="kw">)</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Statistical</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Information'</span>, section)</span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> state_match:</span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a>                jurisdiction <span class="op">=</span> state_match.group(<span class="dv">1</span>).strip()</span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> jurisdiction:</span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a>            jurisdiction <span class="op">=</span> standardize_jurisdiction_name(jurisdiction)</span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract values INCLUDING arrestee which appears starting 2012</span></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a>            offender_match <span class="op">=</span> re.search(<span class="vs">r'Offender</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Profiles</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a>            arrestee_match <span class="op">=</span> re.search(<span class="vs">r'Arrestee</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a>            forensic_match <span class="op">=</span> re.search(<span class="vs">r'Forensic</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Profiles</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a>            ndis_labs_match <span class="op">=</span> re.search(<span class="vs">r'NDIS</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Participating</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Labs</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a>            investigations_match <span class="op">=</span> re.search(<span class="vs">r'Investigations</span><span class="op">?</span><span class="dv">\s</span><span class="op">+</span><span class="vs">Aided</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, section, re.IGNORECASE)</span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> offender_match <span class="kw">and</span> forensic_match:</span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a>                records.append({</span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'timestamp'</span>: timestamp,</span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'report_month'</span>: report_month,</span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'report_year'</span>: report_year,</span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'jurisdiction'</span>: jurisdiction,</span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'offender_profiles'</span>: <span class="bu">int</span>(offender_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'arrestee'</span>: <span class="bu">int</span>(arrestee_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)) <span class="cf">if</span> arrestee_match <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'forensic_profiles'</span>: <span class="bu">int</span>(forensic_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'ndis_labs'</span>: <span class="bu">int</span>(ndis_labs_match.group(<span class="dv">1</span>)) <span class="cf">if</span> ndis_labs_match <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'investigations_aided'</span>: <span class="bu">int</span>(investigations_match.group(<span class="dv">1</span>).replace(<span class="st">','</span>, <span class="st">''</span>)) <span class="cf">if</span> investigations_match <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> records</span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_post2017_ndis(text, timestamp, html_file, report_month<span class="op">=</span><span class="va">None</span>, report_year<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse NDIS snapshots from 2017+ era</span></span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a><span class="co">    Modern format with consistent structure and all fields</span></span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a><span class="co">    Keep using your existing working pattern for this era</span></span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is your existing working pattern - don't change it</span></span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a>    pattern <span class="op">=</span> re.<span class="bu">compile</span>(</span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="kw">(</span><span class="pp">[A-Z][</span><span class="dv">\w\s</span><span class="ch">\.\-\'\/</span><span class="pp">&amp;</span><span class="ch">\(\)</span><span class="pp">]</span><span class="op">+?</span><span class="kw">)</span><span class="vs">Statistical Information'</span></span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="dv">.</span><span class="op">*?</span><span class="vs">Offender Profiles</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span></span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="dv">.</span><span class="op">*?</span><span class="vs">Arrestee</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span></span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="dv">.</span><span class="op">*?</span><span class="vs">Forensic Profiles</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span></span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="dv">.</span><span class="op">*?</span><span class="vs">NDIS Participating Labs</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span></span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'</span><span class="dv">.</span><span class="op">*?</span><span class="vs">Investigations Aided</span><span class="dv">\s</span><span class="op">+</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">,]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>,</span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a>        re.IGNORECASE <span class="op">|</span> re.DOTALL</span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> match <span class="kw">in</span> pattern.finditer(text):</span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a>        records.append({</span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a>            <span class="st">'timestamp'</span>: timestamp,</span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a>            <span class="st">'report_month'</span>: report_month,</span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a>            <span class="st">'report_year'</span>: report_year,</span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a>            <span class="st">'jurisdiction'</span>: standardize_jurisdiction_name(match.group(<span class="dv">1</span>)),</span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a>            <span class="st">'offender_profiles'</span>: <span class="bu">int</span>(match.group(<span class="dv">2</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a>            <span class="st">'arrestee'</span>: <span class="bu">int</span>(match.group(<span class="dv">3</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a>            <span class="st">'forensic_profiles'</span>: <span class="bu">int</span>(match.group(<span class="dv">4</span>).replace(<span class="st">','</span>, <span class="st">''</span>)),</span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ndis_labs'</span>: <span class="bu">int</span>(match.group(<span class="dv">5</span>)),</span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a>            <span class="st">'investigations_aided'</span>: <span class="bu">int</span>(match.group(<span class="dv">6</span>).replace(<span class="st">','</span>, <span class="st">''</span>))</span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> records</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="output-schema" class="level3">
<h3 class="anchored" data-anchor-id="output-schema">Output Schema</h3>
<p>Each extracted record contains the following standardized fields:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Availability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>timestamp</code></td>
<td style="text-align: left;">Wayback capture timestamp (YYYYMMDDHHMMSS)</td>
<td style="text-align: left;">All eras</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>report_month</code></td>
<td style="text-align: left;">Month from “as of” statement</td>
<td style="text-align: left;">2007+ only</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>report_year</code></td>
<td style="text-align: left;">Year from “as of” statement</td>
<td style="text-align: left;">2007+ only</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>jurisdiction</code></td>
<td style="text-align: left;">Standardized state/agency name</td>
<td style="text-align: left;">All eras</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>offender_profiles</code></td>
<td style="text-align: left;">DNA profiles from convicted offenders</td>
<td style="text-align: left;">All eras</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>arrestee</code></td>
<td style="text-align: left;">DNA profiles from arrestees</td>
<td style="text-align: left;">2012+ only</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>forensic_profiles</code></td>
<td style="text-align: left;">Crime scene DNA profiles</td>
<td style="text-align: left;">All eras</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ndis_labs</code></td>
<td style="text-align: left;">Number of participating laboratories</td>
<td style="text-align: left;">All eras</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>investigations_aided</code></td>
<td style="text-align: left;">Cases assisted by DNA matches</td>
<td style="text-align: left;">All eras</td>
</tr>
</tbody>
</table>
</section>
<section id="batch-processing" class="level3">
<h3 class="anchored" data-anchor-id="batch-processing">Batch Processing</h3>
<p>The complete extraction workflow:</p>
<p><strong>File Discovery</strong></p>
<ul>
<li><p>Scans download directory for HTML files</p></li>
<li><p>Sorts chronologically for consistent processing</p></li>
<li><p>Tracks progress with detailed logging</p></li>
</ul>
<p><strong>Individual File Processing</strong></p>
<ul>
<li><p>Reads HTML content with encoding fallback</p></li>
<li><p>Extracts metadata and cleans content</p></li>
<li><p>Routes to era-appropriate parser based on timestamp</p></li>
<li><p>Captures source file information for traceability</p></li>
</ul>
<p><strong>Data Consolidation</strong></p>
<ul>
<li><p>Combines all records into single DataFrame</p></li>
<li><p>Adds derived timestamp columns (capture_date, year)</p></li>
<li><p>Validates data integrity and completeness</p></li>
<li><p>Sorts by capture date and jurisdiction for consistency</p></li>
</ul>
<div id="batch-processing" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show batch processing function code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_ndis_snapshot(html_file):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert single NDIS HTML file to structured data</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Routes to appropriate parser based on timestamp year</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read HTML content with multiple encoding attempts</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        content <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> encoding <span class="kw">in</span> [<span class="st">'utf-8'</span>, <span class="st">'latin-1'</span>, <span class="st">'cp1252'</span>, <span class="st">'iso-8859-1'</span>]:</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                content <span class="op">=</span> html_file.read_text(encoding<span class="op">=</span>encoding)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">UnicodeDecodeError</span>:</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> content <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Final fallback with error ignoring</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>            content <span class="op">=</span> html_file.read_text(encoding<span class="op">=</span><span class="st">'latin-1'</span>, errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if file has reasonable content</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(content.strip()) <span class="op">&lt;</span> <span class="dv">100</span>:</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⚠  Small file detected: </span><span class="sc">{</span>html_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(content)<span class="sc">}</span><span class="ss"> chars)"</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract metadata</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        metadata <span class="op">=</span> extract_ndis_metadata(content)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        timestamp <span class="op">=</span> html_file.stem.split(<span class="st">'_'</span>)[<span class="dv">0</span>]</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            year <span class="op">=</span> <span class="bu">int</span>(timestamp[:<span class="dv">4</span>])</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⚠  Invalid timestamp in filename: </span><span class="sc">{</span>html_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Route to appropriate parser with fallback</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        records <span class="op">=</span> []</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        parser_used <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> year <span class="op">&lt;=</span> <span class="dv">2007</span>:</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>            records <span class="op">=</span> parse_pre2007_ndis(metadata[<span class="st">'clean_text'</span>], timestamp, html_file,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                                       metadata[<span class="st">'report_month'</span>], metadata[<span class="st">'report_year'</span>])</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>            parser_used <span class="op">=</span> <span class="st">"pre2007"</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> year <span class="op">&lt;=</span> <span class="dv">2011</span>:</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>            records <span class="op">=</span> parse_2008_2011_ndis(metadata[<span class="st">'clean_text'</span>], timestamp, html_file,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>                                         metadata[<span class="st">'report_month'</span>], metadata[<span class="st">'report_year'</span>])</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>            parser_used <span class="op">=</span> <span class="st">"2008-2011"</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> year <span class="op">&lt;=</span> <span class="dv">2016</span>:</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>            records <span class="op">=</span> parse_2012_2016_ndis(metadata[<span class="st">'clean_text'</span>], timestamp, html_file,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>                                         metadata[<span class="st">'report_month'</span>], metadata[<span class="st">'report_year'</span>])</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>            parser_used <span class="op">=</span> <span class="st">"2012-2016"</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>            records <span class="op">=</span> parse_post2017_ndis(metadata[<span class="st">'clean_text'</span>], timestamp, html_file,</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>                                        metadata[<span class="st">'report_month'</span>], metadata[<span class="st">'report_year'</span>])</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>            parser_used <span class="op">=</span> <span class="st">"post2017"</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> records:</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add parser info for debugging</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> record <span class="kw">in</span> records:</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>                record[<span class="st">'parser_used'</span>] <span class="op">=</span> parser_used</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                record[<span class="st">'source_file'</span>] <span class="op">=</span> html_file.name</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> records</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"⚠  No records extracted from </span><span class="sc">{</span>html_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (year: </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">, parser: </span><span class="sc">{</span>parser_used<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"❌ Error processing </span><span class="sc">{</span>html_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_all_snapshots():</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="co">    Process all downloaded snapshots into a single DataFrame</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a><span class="co">        Combined dataset with all snapshots</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    all_records <span class="op">=</span> []</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    html_files <span class="op">=</span> <span class="bu">sorted</span>(NDIS_SNAPSHOTS_DIR.glob(<span class="st">"*.html"</span>))</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> HTML snapshots..."</span>)</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>    successful_files <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    failed_files <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    failed_list <span class="op">=</span> []</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> html_file <span class="kw">in</span> tqdm(html_files, desc<span class="op">=</span><span class="st">"Extracting NDIS data"</span>):</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>        records <span class="op">=</span> process_ndis_snapshot(html_file)</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> records:</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>            all_records.extend(records)</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>            successful_files <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>            failed_files <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>            failed_list.append(html_file.name)</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing complete: </span><span class="sc">{</span>successful_files<span class="sc">}</span><span class="ss"> successful, </span><span class="sc">{</span>failed_files<span class="sc">}</span><span class="ss"> failed"</span>)</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save failure report</span></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> failed_list:</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>        failure_report_path <span class="op">=</span> OUTPUT_DIR <span class="op">/</span> <span class="st">"processing_failures.json"</span></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(failure_report_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>            json.dump({</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>                <span class="st">'timestamp'</span>: datetime.now().isoformat(),</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>                <span class="st">'total_files'</span>: <span class="bu">len</span>(html_files),</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>                <span class="st">'successful'</span>: successful_files,</span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>                <span class="st">'failed'</span>: failed_files,</span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>                <span class="st">'failed_files'</span>: failed_list[:<span class="dv">100</span>]  <span class="co"># Limit to first 100</span></span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>            }, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failure report saved: </span><span class="sc">{</span>failure_report_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> all_records:</span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Warning: No records extracted!"</span>)</span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(all_records)</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add derived date columns</span></span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'capture_date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'timestamp'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">%H%M%S'</span>, errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'capture_year'</span>] <span class="op">=</span> df[<span class="st">'capture_date'</span>].dt.year</span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove any records with invalid dates</span></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>    invalid_dates <span class="op">=</span> df[<span class="st">'capture_date'</span>].isna().<span class="bu">sum</span>()</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> invalid_dates <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"⚠  Removed </span><span class="sc">{</span>invalid_dates<span class="sc">}</span><span class="ss"> records with invalid dates"</span>)</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">'capture_date'</span>].notna()]</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.sort_values([<span class="st">'capture_date'</span>, <span class="st">'jurisdiction'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="exp-valid" class="level3">
<h3 class="anchored" data-anchor-id="exp-valid">Export &amp; Validation</h3>
<p>Structured output generation with comprehensive quality control:</p>
<p><strong>Validation Checks:</strong></p>
<ul>
<li><p>Verifies all required columns are present</p></li>
<li><p>Checks for null values in critical fields</p></li>
<li><p>Validates numeric ranges (non-negative counts)</p></li>
<li><p>Confirms timestamp format consistency</p></li>
<li><p>Ensures jurisdiction names contain valid characters</p></li>
</ul>
<p><strong>Export Features</strong></p>
<ul>
<li><p>Saves as UTF-8 encoded CSV for maximum compatibility</p></li>
<li><p>Generates timestamped filenames for version control</p></li>
<li><p>Creates metadata summary with file statistics</p></li>
<li><p>Performs round-trip validation to confirm data integrity</p></li>
</ul>
<p><strong>Quality Metrics</strong></p>
<ul>
<li><p>Records total file count and processing success rate</p></li>
<li><p>Tracks temporal coverage (earliest to latest snapshots)</p></li>
<li><p>Documents jurisdiction coverage across time periods</p></li>
<li><p>Reports data completeness by era and field</p></li>
</ul>
<div id="export-data" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show execution function code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> export_ndis_data(df, output_dir<span class="op">=</span>OUTPUT_DIR):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Export processed NDIS data with comprehensive metadata</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> df.empty:</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Warning: DataFrame is empty, skipping export"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate output filename</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    export_timestamp <span class="op">=</span> datetime.now().strftime(<span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">_%H%M%S"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    csv_path <span class="op">=</span> output_dir <span class="op">/</span> <span class="ss">f"ndis_data_raw.csv"</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Export main dataset</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    df.to_csv(csv_path, index<span class="op">=</span><span class="va">False</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate export metadata</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    file_size_mb <span class="op">=</span> csv_path.stat().st_size <span class="op">/</span> (<span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    export_metadata <span class="op">=</span> {</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'export_timestamp'</span>: export_timestamp,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'export_path'</span>: <span class="bu">str</span>(csv_path.resolve()),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'record_count'</span>: <span class="bu">len</span>(df),</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'file_size_mb'</span>: <span class="bu">round</span>(file_size_mb, <span class="dv">2</span>),</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'unique_snapshots'</span>: df[<span class="st">'timestamp'</span>].nunique(),</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'unique_jurisdictions'</span>: df[<span class="st">'jurisdiction'</span>].nunique(),</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'date_coverage'</span>: {</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">'earliest_capture'</span>: df[<span class="st">'capture_date'</span>].<span class="bu">min</span>().isoformat(),</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">'latest_capture'</span>: df[<span class="st">'capture_date'</span>].<span class="bu">max</span>().isoformat(),</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">'span_years'</span>: df[<span class="st">'capture_year'</span>].<span class="bu">max</span>() <span class="op">-</span> df[<span class="st">'capture_year'</span>].<span class="bu">min</span>() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'data_completeness'</span>: {</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">'with_report_dates'</span>: <span class="bu">len</span>(df[df[<span class="st">'report_year'</span>].notna()]),</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'with_arrestee_data'</span>: <span class="bu">len</span>(df[df[<span class="st">'arrestee'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]),</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_investigations_aided'</span>: <span class="bu">int</span>(df[<span class="st">'investigations_aided'</span>].<span class="bu">sum</span>())</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save metadata</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    metadata_path <span class="op">=</span> output_dir <span class="op">/</span> <span class="ss">f"ndis_export_metadata_</span><span class="sc">{</span>export_timestamp<span class="sc">}</span><span class="ss">.json"</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> json</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(metadata_path, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        json.dump(export_metadata, f, indent<span class="op">=</span><span class="dv">2</span>, default<span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Data exported: </span><span class="sc">{</span>csv_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Metadata saved: </span><span class="sc">{</span>metadata_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Export summary: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> records, </span><span class="sc">{</span>file_size_mb<span class="sc">:.1f}</span><span class="ss"> MB"</span>)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> export_metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Data integrity validation</strong></p>
<ul>
<li><p><strong>Schema Checking:</strong> Ensures proper field types and formats.</p></li>
<li><p><strong>Null Validation:</strong> Confirms mandatory fields are populated.</p></li>
<li><p><strong>Value Sanity Checks:</strong> Verifies non-negative numbers.</p></li>
</ul>
<div id="verify-export" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show validation function code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_extracted_data(df):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Comprehensive validation of extracted NDIS data</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Validating extracted data..."</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Required columns check</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    required_cols <span class="op">=</span> [</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'timestamp'</span>, <span class="st">'jurisdiction'</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'offender_profiles'</span>, <span class="st">'arrestee'</span>, <span class="st">'forensic_profiles'</span>, </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ndis_labs'</span>, <span class="st">'investigations_aided'</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    validation_results <span class="op">=</span> {}</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check column presence</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    missing_cols <span class="op">=</span> <span class="bu">set</span>(required_cols) <span class="op">-</span> <span class="bu">set</span>(df.columns)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'missing_columns'</span>] <span class="op">=</span> <span class="bu">list</span>(missing_cols)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> missing_cols:</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"✗ Missing required columns: </span><span class="sc">{</span>missing_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> validation_results</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data quality checks</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'total_records'</span>] <span class="op">=</span> <span class="bu">len</span>(df)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'unique_timestamps'</span>] <span class="op">=</span> df[<span class="st">'timestamp'</span>].nunique()</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'unique_jurisdictions'</span>] <span class="op">=</span> df[<span class="st">'jurisdiction'</span>].nunique()</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'date_range'</span>] <span class="op">=</span> {</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'earliest'</span>: df[<span class="st">'capture_date'</span>].<span class="bu">min</span>().strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>),</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'latest'</span>: df[<span class="st">'capture_date'</span>].<span class="bu">max</span>().strftime(<span class="st">'%Y-%m-</span><span class="sc">%d</span><span class="st">'</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Null value checks</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    critical_nulls <span class="op">=</span> df[[<span class="st">'jurisdiction'</span>, <span class="st">'offender_profiles'</span>, <span class="st">'forensic_profiles'</span>]].isnull().<span class="bu">sum</span>()</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'critical_nulls'</span>] <span class="op">=</span> critical_nulls.to_dict()</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Value range checks</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    numeric_cols <span class="op">=</span> [<span class="st">'offender_profiles'</span>, <span class="st">'arrestee'</span>, <span class="st">'forensic_profiles'</span>, <span class="st">'ndis_labs'</span>, <span class="st">'investigations_aided'</span>]</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    negative_values <span class="op">=</span> {}</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> numeric_cols:</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        negative_count <span class="op">=</span> (df[col] <span class="op">&lt;</span> <span class="dv">0</span>).<span class="bu">sum</span>()</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> negative_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>            negative_values[col] <span class="op">=</span> negative_count</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'negative_values'</span>] <span class="op">=</span> negative_values</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Era-specific validation</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    pre2007_count <span class="op">=</span> <span class="bu">len</span>(df[df[<span class="st">'capture_year'</span>] <span class="op">&lt;</span> <span class="dv">2007</span>])</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    arrestee_pre2012 <span class="op">=</span> <span class="bu">len</span>(df[(df[<span class="st">'capture_year'</span>] <span class="op">&lt;</span> <span class="dv">2012</span>) <span class="op">&amp;</span> (df[<span class="st">'arrestee'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)])</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    validation_results[<span class="st">'era_checks'</span>] <span class="op">=</span> {</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pre2007_records'</span>: pre2007_count,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">'arrestee_before_2012'</span>: arrestee_pre2012  <span class="co"># Should be 0</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print summary</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Total records: </span><span class="sc">{</span>validation_results[<span class="st">'total_records'</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Unique snapshots: </span><span class="sc">{</span>validation_results[<span class="st">'unique_timestamps'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Unique jurisdictions: </span><span class="sc">{</span>validation_results[<span class="st">'unique_jurisdictions'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Date range: </span><span class="sc">{</span>validation_results[<span class="st">'date_range'</span>][<span class="st">'earliest'</span>]<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>validation_results[<span class="st">'date_range'</span>][<span class="st">'latest'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> validation_results[<span class="st">'critical_nulls'</span>]:</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"! Critical null values found: </span><span class="sc">{</span>validation_results[<span class="st">'critical_nulls'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> validation_results[<span class="st">'negative_values'</span>]:</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"! Negative values found: </span><span class="sc">{</span>validation_results[<span class="st">'negative_values'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> validation_results[<span class="st">'era_checks'</span>][<span class="st">'arrestee_before_2012'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"! Data integrity issue: </span><span class="sc">{</span>validation_results[<span class="st">'era_checks'</span>][<span class="st">'arrestee_before_2012'</span>]<span class="sc">}</span><span class="ss"> arrestee records found before 2012"</span>)</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> validation_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="extraction-execution" class="level4">
<h4 class="anchored" data-anchor-id="extraction-execution">Extraction Execution</h4>
<div id="cell-extract-execution" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Show main execution code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process all snapshots</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    ndis_data <span class="op">=</span> process_all_snapshots()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> ndis_data.empty:</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validate data quality</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        validation_results <span class="op">=</span> validate_extracted_data(ndis_data)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Export if validation passes</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        export_metadata <span class="op">=</span> export_ndis_data(ndis_data)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"EXTRACTION COMPLETE"</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Records extracted: </span><span class="sc">{</span><span class="bu">len</span>(ndis_data)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Time span: </span><span class="sc">{</span>ndis_data[<span class="st">'capture_year'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>ndis_data[<span class="st">'capture_year'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Jurisdictions: </span><span class="sc">{</span>ndis_data[<span class="st">'jurisdiction'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No data extracted - check HTML files and parsing logic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Processing 11358 HTML snapshots...</code></pre>
</div>
<div id="extract-execution" class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e7e4eeba4de84d2dbc22fbc6132672e4","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>⚠  No records extracted from 20120101203804_ndis.html (year: 2012, parser: 2012-2016)
⚠  No records extracted from 20120111115907_ndis.html (year: 2012, parser: 2012-2016)
⚠  No records extracted from 20120508173804_ndis.html (year: 2012, parser: 2012-2016)
⚠  No records extracted from 20161228141646_nj.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228141656_stats.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228141708_ca.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228143828_or.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228143832_mt.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228143841_wy.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228143848_co.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228143853_nm.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228144009_nd.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228144424_sd.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228144434_ne.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228144438_ks.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20161228144451_ok.html (year: 2016, parser: 2012-2016)
⚠  No records extracted from 20210811085903_nj.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085906_stats.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085910_ca.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085918_or.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085922_mt.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085926_wy.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085929_co.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085932_nm.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085935_nd.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085939_sd.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085943_ne.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085947_ks.html (year: 2021, parser: post2017)
⚠  No records extracted from 20210811085950_ok.html (year: 2021, parser: post2017)
⚠  No records extracted from 20220209033036_ndis.html (year: 2022, parser: post2017)
⚠  No records extracted from 20220210054625_ndis.html (year: 2022, parser: post2017)
⚠  No records extracted from 20231113033840_ndis.html (year: 2023, parser: post2017)
⚠  No records extracted from 20240415150311_ndis.html (year: 2024, parser: post2017)
Processing complete: 11325 successful, 33 failed
Failure report saved: ..\data\ndis\raw\ndis_outputs\processing_failures.json
Validating extracted data...
✓ Total records: 32,008
✓ Unique snapshots: 11280
✓ Unique jurisdictions: 169
✓ Date range: 2001-07-15 to 2025-08-15
! Critical null values found: {'jurisdiction': 0, 'offender_profiles': 0, 'forensic_profiles': 0}
✓ Data exported: ..\data\ndis\raw\ndis_outputs\ndis_data_raw.csv
✓ Metadata saved: ..\data\ndis\raw\ndis_outputs\ndis_export_metadata_20251005_225312.json
✓ Export summary: 32,008 records, 3.5 MB

==================================================
EXTRACTION COMPLETE
==================================================
Records extracted: 32,008
Time span: 2001-2025
Jurisdictions: 169</code></pre>
</div>
</div>
<p><a href="../qmd_root/ndis_analysis.html">View Analyses →</a></p>


</section>
</section>
</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"0d996e34f0f144acacc57523ffac92dc":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_c8525e064fb0488a98e0891520c4621c","placeholder":"​","style":"IPY_MODEL_c7e420ea140d44e7a2974144efb7c2ce","tabbable":null,"tooltip":null,"value":"Extracting NDIS data: 100%"}},"2c86cf350d2744b081ebb333c1d431c8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"5574034e32a9434dbf0fdca6c4490c63":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"7f05b843ccf548d19129a485ae77641e":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"9ac1281539a046ed9dd76f46f7d85798":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_d0a1926c0bbd42038f539343f14b8a8b","max":11358,"min":0,"orientation":"horizontal","style":"IPY_MODEL_5574034e32a9434dbf0fdca6c4490c63","tabbable":null,"tooltip":null,"value":11358}},"9c89a116527d410c9efb1f267cb7aecc":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"c7e420ea140d44e7a2974144efb7c2ce":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"c8525e064fb0488a98e0891520c4621c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d0a1926c0bbd42038f539343f14b8a8b":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"e7e4eeba4de84d2dbc22fbc6132672e4":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_0d996e34f0f144acacc57523ffac92dc","IPY_MODEL_9ac1281539a046ed9dd76f46f7d85798","IPY_MODEL_fc97c5c382b24752adecfc58a42464a5"],"layout":"IPY_MODEL_9c89a116527d410c9efb1f267cb7aecc","tabbable":null,"tooltip":null}},"fc97c5c382b24752adecfc58a42464a5":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_7f05b843ccf548d19129a485ae77641e","placeholder":"​","style":"IPY_MODEL_2c86cf350d2744b081ebb333c1d431c8","tabbable":null,"tooltip":null,"value":" 11358/11358 [01:44&lt;00:00, 11.28it/s]"}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>